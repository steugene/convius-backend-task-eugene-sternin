# 🚀 Deployment Guide

This guide covers deploying the Lunch Voting API to production using Railway with automated CI/CD.

## 🏗️ Infrastructure Overview

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   GitHub        │    │   Railway       │    │   PostgreSQL   │
│   Repository    │───▶│   Application   │───▶│   Database      │
│   + Actions     │    │   + Redis       │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       ▼                       │
         │              ┌─────────────────┐              │
         │              │   Monitoring    │              │
         └─────────────▶│   & Logging     │◀─────────────┘
                        └─────────────────┘
```

## 🚂 Railway Deployment

### Prerequisites

1. **Railway Account**: Sign up at [railway.app](https://railway.app)
2. **GitHub Repository**: Push your code to GitHub
3. **Environment Variables**: Prepare production secrets

### Step 1: Create Railway Project

```bash
# Install Railway CLI
curl -fsSL https://railway.app/install.sh | sh

# Login to Railway
railway login

# Create new project
railway project new lunch-voting-api

# Add PostgreSQL database
railway add --database postgresql

# Add Redis (optional, for caching)
railway add --database redis
```

### Step 2: Configure Environment Variables

In Railway dashboard, set these environment variables:

```bash
# Application
ENVIRONMENT=production
DEBUG=false
PROJECT_NAME=Lunch Voting API
VERSION=1.0.0

# Database (auto-generated by Railway)
POSTGRES_SERVER=${{Postgres.POSTGRES_HOST}}
POSTGRES_PORT=${{Postgres.POSTGRES_PORT}}
POSTGRES_USER=${{Postgres.POSTGRES_USER}}
POSTGRES_PASSWORD=${{Postgres.POSTGRES_PASSWORD}}
POSTGRES_DB=${{Postgres.POSTGRES_DB}}

# Security
SECRET_KEY=<generate-strong-secret-key>
ACCESS_TOKEN_EXPIRE_MINUTES=30

# CORS (adjust for your frontend domain)
BACKEND_CORS_ORIGINS=https://your-frontend-domain.com,https://www.your-frontend-domain.com

# Logging
LOG_LEVEL=INFO

# Rate Limiting
REQUESTS_PER_MINUTE=60
```

### Step 3: Set Up GitHub Secrets

In your GitHub repository, go to Settings → Secrets and variables → Actions:

```bash
RAILWAY_TOKEN=<your-railway-api-token>
RAILWAY_URL=<your-deployed-app-url>
```

### Step 4: Deploy

```bash
# Connect GitHub repository to Railway
railway connect

# Deploy
railway up
```

## 🔄 CI/CD Pipeline

### Workflow Overview

1. **On Pull Request**: Run tests, linting, type checking
2. **On Push to Main**: Run tests → Deploy to production → Health check
3. **On Manual Trigger**: Deploy without waiting for push

### GitHub Actions Features

- ✅ **Multi-Python Testing** (3.9, 3.11)
- ✅ **Code Quality Checks** (Black, isort, flake8, mypy)
- ✅ **Database Testing** (PostgreSQL service)
- ✅ **Coverage Reports** (Codecov integration)
- ✅ **Automated Deployment** (Railway)
- ✅ **Health Checks** (Post-deployment verification)
- ✅ **Rollback Support** (Manual trigger available)

### Triggering Deployments

```bash
# Automatic deployment
git push origin main

# Manual deployment
# Go to GitHub Actions → Deploy to Production → Run workflow
```

## 🗄️ Database Management

### Running Migrations

```bash
# In Railway project
railway shell

# Run migrations
alembic upgrade head

# Check migration status
alembic current
```

### Database Backup

```bash
# Create backup
railway db backup

# Download backup
railway db download <backup-id>
```

## 📊 Monitoring & Observability

### Health Checks

The application provides comprehensive health check endpoints:

```bash
# Basic health
curl https://your-app.railway.app/health

# Readiness check (includes DB)
curl https://your-app.railway.app/health/ready

# Liveness check
curl https://your-app.railway.app/health/live

# Application metrics
curl https://your-app.railway.app/metrics/health
```

### Prometheus Metrics

Available at `/metrics` endpoint:

- HTTP request metrics
- Database connection metrics
- Vote counting metrics
- Custom application metrics

### Logging

Structured JSON logging with:

- Request/response tracking
- Error tracking with stack traces
- Performance metrics
- Security events

View logs in Railway:

```bash
railway logs
```

## 🔒 Security Checklist

### Pre-Deployment

- [ ] **Environment Variables**: All sensitive data in env vars
- [ ] **Secret Key**: Strong, unique secret key set
- [ ] **Database**: Secure database credentials
- [ ] **CORS**: Proper CORS origins configured
- [ ] **Rate Limiting**: Appropriate rate limits set
- [ ] **Debug Mode**: Disabled in production

### Post-Deployment

- [ ] **HTTPS**: SSL certificate active
- [ ] **Security Headers**: All security headers present
- [ ] **Database**: Database access restricted
- [ ] **Monitoring**: Error tracking configured
- [ ] **Backups**: Automated backups enabled

## 🚨 Troubleshooting

### Common Issues

**Deployment Fails**

```bash
# Check Railway logs
railway logs

# Check build logs
railway logs --build

# Restart service
railway restart
```

**Database Connection Issues**

```bash
# Test database connection
railway shell
python -c "from app.db.session import engine; print(engine.execute('SELECT 1').scalar())"

# Check database status
railway status
```

**Environment Variable Issues**

```bash
# List all environment variables
railway variables

# Set environment variable
railway variables set KEY=value
```

### Performance Issues

**High Response Times**

1. Check database query performance
2. Review application logs
3. Scale up workers: Update `railway.toml`

```toml
[deploy]
startCommand = "gunicorn app.main:app --workers 8 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT"
```

**High Memory Usage**

1. Monitor with Railway metrics
2. Optimize database queries
3. Scale up memory: Upgrade Railway plan

## 📈 Scaling

### Horizontal Scaling

```bash
# Scale workers in railway.toml
[deploy]
startCommand = "gunicorn app.main:app --workers 6 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT"

# Or use auto-scaling
replicas = 2
```

### Database Scaling

```bash
# Upgrade PostgreSQL plan in Railway
railway db scale --plan pro

# Optimize connection pooling
# Update app/db/session.py pool settings
```

## 🔄 Rollback Strategy

### Automatic Rollback

Railway supports automatic rollbacks on health check failures.

### Manual Rollback

```bash
# List deployments
railway deployments

# Rollback to previous deployment
railway rollback <deployment-id>
```

### Zero-Downtime Deployment

Railway provides zero-downtime deployments by default:

1. Builds new version
2. Runs health checks
3. Switches traffic gradually
4. Keeps old version for rollback

## 📋 Maintenance

### Regular Tasks

- **Weekly**: Review logs and metrics
- **Monthly**: Update dependencies
- **Quarterly**: Security audit
- **Annually**: Disaster recovery test

### Updates

```bash
# Update dependencies
pip install --upgrade -r requirements.txt

# Update database schema
alembic revision --autogenerate -m "Description"
alembic upgrade head

# Deploy updates
git push origin main
```

## 🆘 Support

### Railway Resources

- [Railway Documentation](https://docs.railway.app/)
- [Railway Discord](https://discord.gg/railway)
- [Railway Status](https://status.railway.app/)

### Application Support

- Check GitHub Issues
- Review application logs
- Contact development team

---

🎉 **Congratulations!** Your Lunch Voting API is now deployed with production-grade CI/CD pipeline! 